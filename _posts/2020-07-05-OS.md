---
layout: post
title:  "操作系统原理(一)"
categories: 操作系统
tags:   操作系统
author: ZyWang
excerpt: 操作系统原理 
---

****

# 参考资料 #

[https://www.bilibili.com/video/BV1uW411f72n](https://www.bilibili.com/video/BV1uW411f72n)

## 操作系统启动 ##

![](https://s1.ax1x.com/2020/07/05/Upk9qs.jpg)

![](https://s1.ax1x.com/2020/07/05/Upk6SS.jpg)

![](https://s1.ax1x.com/2020/07/05/UpEYbd.jpg)

DISK 存放OS

BIOS 基本I/O处理系统，用来检测各种外设，加载响应软件

Bootloader 加载OS，将OS从Disk加载到内存中

POST加电自检，寻找显卡和执行BIOS

## 中断、异常和系统调用 ##

中断、I/O面向外设

系统调用和异常面向应用程序

系统调用:来源于应用程序向OS发出服务请求

异常:来源于不良的应用程序，非法指令或者其他坏的处理状态，如内存出错

中断:来源于外设，来自不同硬件设备的计时器和网络的中断

**为什么应用程序不直接与底层交互？**

内核是被信任的第三方，只有内核可以执行特权指令，为例方便应用程序，屏蔽底层的复杂性和差异性。

**中断、异常、系统调用三者差异？**

源头:中断来源于外设、异常来源于应用程序想不到的行为、系统调用来源于应用程序请求操作系统提供服务，比如打开关闭文件、读写文件、发送某个包。

处理时间:中断异步时间点，异常同步事件，系统调用异步(返回数据)和同步(发出请求)都有可能。

响应:中断，持续，对用户应用程序是透明的；异常，杀死或重新执行意想不到的应用程序指令；系统调用，等待和持续。

**中断和异常的处理机制**

中断是外设的事件，异常时内部cpu的事件。

中断和异常都有keys表，用来标识唯一中断或异常服务。

硬件:设置中断标记，将内部、外部事件设置中断标记，cpu根据中断标记找到中断ID发送给操作系统，操作系统通过中断ID找到查表找到对应的中断。

软件:**中断**操作系统保存当前处理状态，比如执行到什么地方，寄存器中的内容，方便恢复现场；中断服务程序处理，根据中断服务执行；清除中断标记，恢复之前保存的处理状态。
**异常**保存现场；异常处理，可以杀死异常程序或者重新执行异常指令；恢复现场。

**系统调用**

应用程序和系统内核之间的接口，Win32 API、POSIX API等等，通过系统调用访问系统资源。

用户态 应用程序在执行过程中，cpu所处于的特权指令的状态，特权级低，不能直接访问某些特殊的机器指令和I/O。 3级特权级

内核态 操作系统再执行过程中，cpu所处于的特权指令的状态，可以执行任何一条特权指令。 0级特权级

一次系统调用，会完成用户态到内核态的转换，当然异常和外围设备中断也会完成用户态到内核态的转换。

**系统调用和函数调用的区别**

函数调用在一个栈空间完成参数传递，和参数返回。
系统调用中应用程序和内核拥有各自的堆栈，所以需要切换堆栈同时完成特权级的转换，堆栈的切换需要一定的开销，但是安全和可靠。

**跨越操作系统边界的开销**

在执行时间上的开销超过程序调用

**开销:**

1.建立中断/异常/系统调用与对应服务例程映射关系表需要初始化开销

2.建立内核堆栈开销

3.验证传递过来的参数的安全性和可靠性

4.内核态映射到用户态的地址空间，将数据拷贝到用户态的地址空间

## 内存分层 ##

![](https://s1.ax1x.com/2020/07/05/UpD691.jpg)


![](https://s1.ax1x.com/2020/07/05/UprPg0.jpg)

操作系统需要完成抽象、保护、共享和虚拟化内存空间四个功能。

p1-p4是4段程序，逻辑地址空间是程序运行的空间，物理空间是主存、硬盘。

os管理内存的不同方法:1.程序重定位2.分段3.分页4.虚拟内存5.按需分页虚拟内存

## 地址空间 ##

定义: 物理地址空间，硬件支持的地址空间；逻辑地址空间，一个运行程序所拥有的内存范围

地址生成:1.物理地址生成；cpu执行某条指令时，ALU部件会需要该指令的内容，发出请求，参数为逻辑地址；cpu中的mmu部件查找逻辑地址中的映射域是否存在对应的物理地址；如果没有，即去内存中找，找到之后，cpu控制器会向主存发出请求，物理地址的内容，主存返回指令的内容。操作系统负责建立两个地址的映射关系。

![](https://s1.ax1x.com/2020/07/05/UpOede.png)

地址安全检查:程序之间不能相互干扰，通过设置逻辑地址空间的基址和界限

## 连续内存分配 ##

**内存碎片**

外部碎片和内部碎片，外碎片指的是分配单元之间未使用的内存；内碎片指的是分配单元中未使用的内存。

**内存分配策略**

首次适配，使用第一个可用空闲块，空闲块的尺寸比需要的尺寸大。简单，容易产生更大的空闲块；会产生外部碎片

最优适配，寻找整个空闲块中最适合的空闲块，两者差值最小。避免了大空闲块拆散；重分配慢

最差适配，寻找整个空闲块中差值最大的空闲块。拆分大的空闲块；容易破坏大的空闲块

**压缩式碎片整理**

![](https://s1.ax1x.com/2020/07/05/UpjqxI.jpg)

**交换式碎片整理**

![](https://s1.ax1x.com/2020/07/05/Upz8UO.jpg)

## 非连续内存分配 ##

为什么需要非连续内存分配？

连续内存分配会产生内存碎片问题，内存利用率低；

使用非连续内存分配的好处:一个程序的物理地址空间可以是非连续的，可以更好的利用内存和管理内存，支持动态加载和动态链接，允许共享代码与数据。

非连续内存分配的硬件方案:分页和分段

**分段**

更好的分离和共享

程序逻辑地址空间是连续的，物理地址空间是分段的不连续的

![](https://s1.ax1x.com/2020/07/05/Upzwrt.jpg)

分段寻址方案:一个段=一个内存块，程序访问地址需要一个二元组(s,addr)，s代表段号，addr代表段内偏移

![](https://s1.ax1x.com/2020/07/05/U9SJe0.jpg)

注意，此处箭头反了，base和limit的指向，段表由操作系统建立

![](https://s1.ax1x.com/2020/07/05/U99S8e.jpg)

**分页**

绝大部分cpu采用分页机制

页的尺寸是固定的不变的，段的大小是可变的

划分物理内存至固定大小的帧；划分逻辑地址空间至相同大小的页，大小都是二的幂，页表来建立映射关系。

